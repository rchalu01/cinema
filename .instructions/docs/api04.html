<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta http-equiv="X-UA-Compatible" content="IE=edge"/><title>Étape 4 : Projet Symfony - API FOS-rest - US &amp; API · DWCS</title><meta name="viewport" content="width=device-width"/><meta name="generator" content="Docusaurus"/><meta name="description" content="## Objectifs"/><meta name="docsearch:version" content="16.0.0"/><meta name="docsearch:language" content="en"/><meta property="og:title" content="Étape 4 : Projet Symfony - API FOS-rest - US &amp; API · DWCS"/><meta property="og:type" content="website"/><meta property="og:url" content="http://localhost:9996/index.html"/><meta property="og:description" content="## Objectifs"/><meta property="og:image" content="http://localhost:9996/img/undraw_online.svg"/><meta name="twitter:card" content="summary"/><meta name="twitter:image" content="http://localhost:9996/img/undraw_tweetstorm.svg"/><link rel="shortcut icon" href="/"/><link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/default.min.css"/><script type="text/javascript" src="https://buttons.github.io/buttons.js"></script><script src="/js/scrollSpy.js"></script><link rel="stylesheet" href="/css/main.css"/><script src="/js/codetabs.js"></script></head><body class="sideNavVisible separateOnPageNav"><div class="fixedHeaderContainer"><div class="headerWrapper wrapper"><header><a href="/"><h2 class="headerTitle">DWCS</h2></a><a href="/versions.html"><h3>16.0.0</h3></a><div class="navigationWrapper navigationSlider"><nav class="slidingNav"><ul class="nav-site nav-site-internal"><li class="siteNavGroupActive"><a href="/docs/etape0.html" target="_self">Les instructions</a></li></ul></nav></div></header></div></div><div class="navPusher"><div class="docMainWrapper wrapper"><div class="docsNavContainer" id="docsNav"><nav class="toc"><div class="toggleNav"><section class="navWrapper wrapper"><div class="navBreadcrumb wrapper"><div class="navToggle" id="navToggler"><div class="hamburger-menu"><div class="line1"></div><div class="line2"></div><div class="line3"></div></div></div><h2><i>›</i><span>API</span></h2><div class="tocToggler" id="tocToggler"><i class="icon-toc"></i></div></div><div class="navGroups"><div class="navGroup"><h3 class="navGroupCategoryTitle">Le back-office</h3><ul class=""><li class="navListItem"><a class="navItem" href="/docs/etape0.html">Préambule</a></li><li class="navListItem"><a class="navItem" href="/docs/etape1.html">Étape 1</a></li><li class="navListItem"><a class="navItem" href="/docs/etape2.html">Étape 2</a></li><li class="navListItem"><a class="navItem" href="/docs/etape3.html">Étape 3</a></li><li class="navListItem"><a class="navItem" href="/docs/etape4.html">Étape 4</a></li><li class="navListItem"><a class="navItem" href="/docs/etape5.html">Étape 5</a></li><li class="navListItem"><a class="navItem" href="/docs/etape6.html">Étape 6</a></li><li class="navListItem"><a class="navItem" href="/docs/etape7.html">Étape 7</a></li><li class="navListItem"><a class="navItem" href="/docs/etape8.html">Étape 8</a></li><li class="navListItem"><a class="navItem" href="/docs/etape9.html">Étape 9</a></li><li class="navListItem"><a class="navItem" href="/docs/etape10.html">Étape 10</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle">API</h3><ul class=""><li class="navListItem"><a class="navItem" href="/docs/api01.html">Étape 1</a></li><li class="navListItem"><a class="navItem" href="/docs/api02.html">Étape 2</a></li><li class="navListItem"><a class="navItem" href="/docs/api03.html">Étape 3</a></li><li class="navListItem navListItemActive"><a class="navItem" href="/docs/api04.html">Étape 4</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle">Vue d&#x27;avion</h3><ul class=""><li class="navListItem"><a class="navItem" href="/docs/vueAvion.html">Vue d&#x27;avion</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle">Backlog</h3><ul class=""><li class="navListItem"><a class="navItem" href="/docs/stories/projet.html">La commande</a></li><li class="navListItem"><a class="navItem" href="/docs/stories/story1.html">Story 1</a></li><li class="navListItem"><a class="navItem" href="/docs/stories/story2.html">Story 2</a></li><li class="navListItem"><a class="navItem" href="/docs/stories/story3.html">Story 3</a></li><li class="navListItem"><a class="navItem" href="/docs/stories/story4.html">Story 4</a></li><li class="navListItem"><a class="navItem" href="/docs/stories/story5.html">Story 5</a></li><li class="navListItem"><a class="navItem" href="/docs/stories/story6.html">Story 6</a></li><li class="navListItem"><a class="navItem" href="/docs/stories/story7.html">Story 7</a></li></ul></div></div></section></div><script>
            var coll = document.getElementsByClassName('collapsible');
            var checkActiveCategory = true;
            for (var i = 0; i < coll.length; i++) {
              var links = coll[i].nextElementSibling.getElementsByTagName('*');
              if (checkActiveCategory){
                for (var j = 0; j < links.length; j++) {
                  if (links[j].classList.contains('navListItemActive')){
                    coll[i].nextElementSibling.classList.toggle('hide');
                    coll[i].childNodes[1].classList.toggle('rotate');
                    checkActiveCategory = false;
                    break;
                  }
                }
              }

              coll[i].addEventListener('click', function() {
                var arrow = this.childNodes[1];
                arrow.classList.toggle('rotate');
                var content = this.nextElementSibling;
                content.classList.toggle('hide');
              });
            }

            document.addEventListener('DOMContentLoaded', function() {
              createToggler('#navToggler', '#docsNav', 'docsSliderActive');
              createToggler('#tocToggler', 'body', 'tocActive');

              var headings = document.querySelector('.toc-headings');
              headings && headings.addEventListener('click', function(event) {
                var el = event.target;
                while(el !== headings){
                  if (el.tagName === 'A') {
                    document.body.classList.remove('tocActive');
                    break;
                  } else{
                    el = el.parentNode;
                  }
                }
              }, false);

              function createToggler(togglerSelector, targetSelector, className) {
                var toggler = document.querySelector(togglerSelector);
                var target = document.querySelector(targetSelector);

                if (!toggler) {
                  return;
                }

                toggler.onclick = function(event) {
                  event.preventDefault();

                  target.classList.toggle(className);
                };
              }
            });
        </script></nav></div><div class="container mainContainer docsContainer"><div class="wrapper"><div class="post"><header class="postHeader"><h1 id="__docusaurus" class="postHeaderTitle">Étape 4 : Projet Symfony - API FOS-rest - US &amp; API</h1></header><article><div><span><h2><a class="anchor" aria-hidden="true" id="objectifs"></a><a href="#objectifs" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Objectifs</h2>
<ul>
<li>Étudier l'API à mettre en place pour répondre à la demande</li>
<li>Développer  et tester l'API</li>
<li>Intégrer l'API au back-office</li>
</ul>
<h2><a class="anchor" aria-hidden="true" id="développement"></a><a href="#développement" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Développement</h2>
<p>Tous le développement concerné par cette étape se fait dans le conteneur <code>api</code>.</p>
<h2><a class="anchor" aria-hidden="true" id="branches-dans-la-répo-git"></a><a href="#branches-dans-la-répo-git" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Branches dans la répo GIT</h2>
<ul>
<li>Branche <code>api4</code> : doit contenir le projet à l'étape <code>API - Etape 4</code>.<br>
<strong>Important</strong> : la branche <code>api4</code> sera fusionnée (merge) dans la branche <code>master</code></li>
</ul>
<pre><code class="hljs css language-bash"><span class="hljs-comment"># Normalement, la dernière branche de `api` est "api3"</span>
<span class="hljs-comment"># On se met dans cette branche </span>
git checkout api3

<span class="hljs-comment"># Créer la branche api4</span>
git checkout -b api4

<span class="hljs-comment"># Mettre à jour la branche</span>
{
git add . 
git commit -m <span class="hljs-string">"api4 : initial"</span>
git push --<span class="hljs-built_in">set</span>-upstream origin api4
}
</code></pre>
<h2><a class="anchor" aria-hidden="true" id="spécification-de-lapi-par-us"></a><a href="#spécification-de-lapi-par-us" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Spécification de l'API par US</h2>
<table>
<thead>
<tr><th>US</th><th>Rôle</th><th>Description route</th><th>nom contôleur</th><th>nom route</th><th>url route</th></tr>
</thead>
<tbody>
<tr><td>US1</td><td>admin</td><td>consulter la liste des cinémas</td><td>ApiCinemaAdminController.php</td><td>listeCinemas</td><td>@Rest\Get(&quot;/api/cinemas&quot;)</td></tr>
<tr><td>US1</td><td>admin</td><td>détails d'un cinéma</td><td>ApiCinemaAdminController.php</td><td>getCinema</td><td>@Rest\Get(&quot;/api/cinemas/{id}&quot;)</td></tr>
<tr><td>US2</td><td>respProg</td><td>consulter la liste des cinémas</td><td>ApiCinemaAdminController.php</td><td>listeCinemas</td><td>@Rest\Get(&quot;/api/cinemas&quot;)</td></tr>
<tr><td>US2</td><td>respProg</td><td>détails d'un cinéma</td><td>ApiCinemaAdminController.php</td><td>getCinema</td><td>@Rest\Get(&quot;/api/cinemas/{id}&quot;)</td></tr>
<tr><td>US3</td><td>respProg</td><td>détails d'un cinéma</td><td>ApiCinemaAdminController.php</td><td>getCinema</td><td>@Rest\Get(&quot;/api/cinemas/{id}&quot;)</td></tr>
<tr><td>US3</td><td>respProg</td><td>liste des films à l'affiche d'un cinéma</td><td>ApiFilmAAficheController.php</td><td>listeFilmsAAfiche</td><td>@Rest\Get(&quot;/api/filmsAAFiche/{id}&quot;)</td></tr>
<tr><td>US4</td><td>respProg</td><td>liste des films disponibles</td><td>ApiFilmController.php</td><td>listFilms</td><td>@Rest\Get(&quot;/api/cinemas/{id}/films&quot;)</td></tr>
<tr><td>US5</td><td>respProg</td><td>détails d'un film</td><td>ApiFilmController.php</td><td>getFilm</td><td>@Rest\Get(&quot;/api/films/{id}&quot;)</td></tr>
<tr><td>US6</td><td>respProg</td><td>ajouter un film à l’affiche d’un cinéma</td><td>ApiFilmAAficheController.php</td><td>postFilmAAfiche</td><td>@Rest\Post(&quot;/api/filmsAAFiche/{id}/{id}&quot;)</td></tr>
<tr><td>US7</td><td>respProg</td><td>enlever un film de l’affiche d’un cinéma</td><td>ApiFilmAAficheController.php</td><td>deletefilmAAfiche</td><td>@Rest\Delete(&quot;/api/filmsAAFiche/{id_cinema}/{id}&quot;)</td></tr>
</tbody>
</table>
<h2><a class="anchor" aria-hidden="true" id="conditions-particulière-à-appliquer-à-lapi"></a><a href="#conditions-particulière-à-appliquer-à-lapi" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Conditions particulière à appliquer à l'API</h2>
<ul>
<li><p>US4 : Cette page affichera les films disponibles pour chaque film on aura l’image de son affiche et son titre. Avec possibilité d’accéder au détail des informations sur un film</p></li>
<li><p>US5 : Au clic sur le titre du film dans la liste des films on pourra connaître, son résumé, ses acteurs principaux, son réalisateur.</p></li>
<li><p>US6 : le premier <code>id=Cinema.id</code>, le second <code>id=Film.id</code>.<br>
Je ne peux pas mettre deux fois un même film à l’affiche d’un cinéma donné.</p></li>
<li><p>US7 : <code>id=Film.id</code>    <br>
Envoyer une confirmation après avoir enlever le film de l'affiche d'un cinéma</p></li>
</ul>
<h2><a class="anchor" aria-hidden="true" id="implémentation"></a><a href="#implémentation" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Implémentation</h2>
<h3><a class="anchor" aria-hidden="true" id="us3--liste-des-films-à-laffiche-dun-cinéma"></a><a href="#us3--liste-des-films-à-laffiche-dun-cinéma" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>US3 : liste des films à l'affiche d'un cinéma</h3>
<table>
<thead>
<tr><th>US</th><th>Rôle</th><th>Description route</th><th>nom contôleur</th><th>nom route</th><th>url route</th></tr>
</thead>
<tbody>
<tr><td>US3</td><td>respProg</td><td>liste des films à l'affiche d'un cinéma</td><td>ApiFilmAAficheController.php</td><td>listeFilmsAAfiche</td><td>@Rest\Get(&quot;/api/filmsAAFiche/{id}&quot;)</td></tr>
</tbody>
</table>
<h3><a class="anchor" aria-hidden="true" id="création-du-contrôleur-apifilmaafichecontrollerphp"></a><a href="#création-du-contrôleur-apifilmaafichecontrollerphp" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Création du contrôleur <code>ApiFilmAAficheController.php</code></h3>
<pre><code class="hljs css language-bash">php bin/console make:controller ApiFilmAAficheController
</code></pre>
<h3><a class="anchor" aria-hidden="true" id="route--get-apifilmsaaficheid"></a><a href="#route--get-apifilmsaaficheid" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Route : <code>Get /api/filmsAAFiche/{id}</code></h3>
<pre><code class="hljs css language-php"><span class="hljs-comment">/**
    * <span class="hljs-doctag">@Rest</span>\View()
    * <span class="hljs-doctag">@Rest</span>\Get("/api/filmsAAFiche/{id}")
    */</span>
<span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">listeFilmsAAfiche</span><span class="hljs-params">(
                Cinema $cinema,
                ProgrammationCinemaHandler $handler)</span></span>{

    $query = <span class="hljs-keyword">new</span> ProgrammationCinemaQuery($cinema);
    $listeFilmsAAFiche = $handler-&gt;handle($query);
    <span class="hljs-keyword">return</span> $listeFilmsAAFiche;
}
</code></pre>
<h3><a class="anchor" aria-hidden="true" id="test-"></a><a href="#test-" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Test :</h3>
<div align="center" ><img alt="" src="/img/api4/capture0.png" width="400" height="200" /></div>
<h3><a class="anchor" aria-hidden="true" id="sérialisation-des-entités-avec-des-relations"></a><a href="#sérialisation-des-entités-avec-des-relations" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Sérialisation des entités avec des relations</h3>
<p>Plusieurs problèmes peuvent apparaître lors de la sérialisation d'une entités avec des relations, dont deux principalement :</p>
<ul>
<li>le lazy loading : chargement d'attributs gérés par le proxy doctrine pour la sérialisation, comme le montre la figure ci-dessous avec l'apparition de l'attribut <code>__isInitialized=true</code></li>
<li>la référence circulaire : quand il y a une relation bidirectionnelle entre deux entités, alors la sérialisation d'une entité enclenche la sérialisation de la seconde entité, qui donc va enclencher elle même la sérialisation de la première entié, et ainsi de suite.</li>
</ul>
<p>Pour prévenir ce genre de problèmes, le sérialiseur de Symfony utilise <a href="http://symfony.com/doc/current/components/serializer.html#attributes-groups">la notion de groupe</a>. L'objectif des groupes est de définir les attributs qui seront sérialisés selon la vue que nous voulons afficher.</p>
<h3><a class="anchor" aria-hidden="true" id="sérialisation-des-films-à-laffiche-dun-cinéma"></a><a href="#sérialisation-des-films-à-laffiche-dun-cinéma" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Sérialisation des films à l'affiche d'un cinéma</h3>
<h4><a class="anchor" aria-hidden="true" id="ajout-de-lannotation-de-groupe-filmsaafiche-dans-lentité-filmaaffiche-pour-lattribut-film"></a><a href="#ajout-de-lannotation-de-groupe-filmsaafiche-dans-lentité-filmaaffiche-pour-lattribut-film" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Ajout de l'annotation de groupe <code>filmsAAFiche</code> dans l'entité <code>FilmAAffiche</code> pour l'attribut <code>$film</code></h4>
<pre><code class="hljs css language-php"><span class="hljs-keyword">use</span> <span class="hljs-title">Symfony</span>\<span class="hljs-title">Component</span>\<span class="hljs-title">Serializer</span>\<span class="hljs-title">Annotation</span>\<span class="hljs-title">Groups</span>;

<span class="hljs-comment">/**
 * <span class="hljs-doctag">@ORM</span>\Entity(repositoryClass="DoctrineProgrammeDeCinema")
 */</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">FilmAAffiche</span>
</span>{
    ... 
    ...
    
    <span class="hljs-comment">/**
     * <span class="hljs-doctag">@ORM</span>\ManyToOne(targetEntity="App\Entity\Film")
     * <span class="hljs-doctag">@ORM</span>\JoinColumn(nullable=false)
     * <span class="hljs-doctag">@Groups</span>("filmsAAFiche")
     */</span>
    <span class="hljs-keyword">private</span> $film;
    ...
}
</code></pre>
<h4><a class="anchor" aria-hidden="true" id="ajout-des-attributs-de-lentité-film-dans-le-groupe-filmaaffiche"></a><a href="#ajout-des-attributs-de-lentité-film-dans-le-groupe-filmaaffiche" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Ajout des attributs de l'entité <code>Film</code> dans le groupe <code>FilmAAffiche</code></h4>
<pre><code class="hljs css language-php"><span class="hljs-keyword">use</span> <span class="hljs-title">Symfony</span>\<span class="hljs-title">Component</span>\<span class="hljs-title">Serializer</span>\<span class="hljs-title">Annotation</span>\<span class="hljs-title">Groups</span>;

<span class="hljs-comment">/**
 * <span class="hljs-doctag">@ORM</span>\Entity(repositoryClass="App\Repository\DoctrineCatalogueDeFilms")
 */</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Film</span>
</span>{

    <span class="hljs-comment">/**
     * <span class="hljs-doctag">@ORM</span>\Id()
     * <span class="hljs-doctag">@ORM</span>\GeneratedValue()
     * <span class="hljs-doctag">@ORM</span>\Column(type="integer")
     * <span class="hljs-doctag">@Groups</span>("filmsAAFiche")
     */</span>
    <span class="hljs-keyword">private</span> $id;

    <span class="hljs-comment">/**
     * <span class="hljs-doctag">@ORM</span>\Column(type="string", length=255)
     * <span class="hljs-doctag">@Groups</span>("filmsAAFiche")
     */</span>
    <span class="hljs-keyword">private</span> $titre;
    ...
}
</code></pre>
<h4><a class="anchor" aria-hidden="true" id="dans-le-contrôleur-apifilmaafichecontroller-restreindre-la-vue-de-la-route-listefilmsaafiche-au-groupe-filmaaffiche"></a><a href="#dans-le-contrôleur-apifilmaafichecontroller-restreindre-la-vue-de-la-route-listefilmsaafiche-au-groupe-filmaaffiche" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Dans le contrôleur <code>ApiFilmAAficheController</code>, restreindre la vue de la route <code>listeFilmsAAfiche</code> au groupe <code>FilmAAffiche</code></h4>
<pre><code class="hljs css language-php"><span class="hljs-comment">/**
    * <span class="hljs-doctag">@Rest</span>\View(serializerGroups={"filmsAAFiche"})
    * <span class="hljs-doctag">@Rest</span>\Get("/api/filmsAAFiche/{id}")
    */</span>
<span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">listeFilmsAAfiche</span><span class="hljs-params">(
                Cinema $cinema, 
                ProgrammationCinemaHandler $handler)</span></span>{
    $query = <span class="hljs-keyword">new</span> ProgrammationCinemaQuery($cinema);
    $listeFilmsAAFiche = $handler-&gt;handle($query);
    <span class="hljs-keyword">return</span> $listeFilmsAAFiche;
}
</code></pre>
<h4><a class="anchor" aria-hidden="true" id="test"></a><a href="#test" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Test</h4>
<div align="center" ><img alt="" src="/img/api4/capture01.png" width="400" height="200" /></div>
<h3><a class="anchor" aria-hidden="true" id="us6--ajouter-un-film-à-laffiche-dun-cinéma"></a><a href="#us6--ajouter-un-film-à-laffiche-dun-cinéma" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>US6 : ajouter un film à l’affiche d’un cinéma</h3>
<table>
<thead>
<tr><th>US</th><th>Rôle</th><th>Description route</th><th>nom contôleur</th><th>nom route</th><th>url route</th></tr>
</thead>
<tbody>
<tr><td>US6</td><td>respProg</td><td>ajouter un film à l’affiche d’un cinéma</td><td>ApiFilmAAficheController.php</td><td>postFilmAAfiche</td><td>@Rest\Post(&quot;/api/filmsAAFiche/{id_cinema}/{id_film}&quot;)</td></tr>
</tbody>
</table>
<h3><a class="anchor" aria-hidden="true" id="route--post-apifilmsaaficheid_cinemaid_film"></a><a href="#route--post-apifilmsaaficheid_cinemaid_film" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Route : <code>Post /api/filmsAAFiche/{id_cinema}/{id_film}</code></h3>
<h4><a class="anchor" aria-hidden="true" id="problème-à-résoudre"></a><a href="#problème-à-résoudre" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Problème à résoudre</h4>
<p>Dans cette route, l'attibut <code>id_cinema</code>, resp. <code>id_film</code>, doit désigner l'attribut <code>id</code> de l'entité <code>Cinema</code>, resp. l'attribut <code>id</code> de l'entité <code>Film</code>. Cette correspondance, ne peut pas être prise en charge automatiquement par les <code>ParamConverter</code>.</p>
<h4><a class="anchor" aria-hidden="true" id="objectif-du-paramconverter"></a><a href="#objectif-du-paramconverter" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Objectif du <code>ParamConverter</code></h4>
<p>L'objectif du <code>ParamConverter</code> est de transformer automatiquement un paramètre de route, comme <code>{id}</code> par exemple, en un objet d'une entité spécifiée dans la signature de la méthode de la route. Autrement dit, il permet d’injecter automatiquement des objets dans les paramètres d’une action dont on a précisé le type.</p>
<p>Nous avons appliqué ce principe dans tous nos contrôleurs. Rappelons brièvement comment ça marche.</p>
<h4><a class="anchor" aria-hidden="true" id="paramconverter--comment-ça-marche-"></a><a href="#paramconverter--comment-ça-marche-" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>ParamConverter : comment ça marche ?</h4>
<p>Lorsque l’on appelle une action de contrôleur, un événement <code>kernel.controller</code> est déclenché. La classe <code>ParamConverterListener</code> va se charger d’écouter cet événement et de demander à Symfony d’exécuter tous les ParamConverter disponibles, un à un (il est possible de leur assigner un poids pour les prioriser). Cette action sera réalisée jusqu’à ce qu’il trouve un convertisseur capable de gérer les paramètres disponibles dans la signature de la fonction.</p>
<p>Une fois le bon convertisseur trouvé, il se passe plusieurs choses :</p>
<ul>
<li>le convertisseur va d’abord essayer de trouver un objet correspondant avec les attributs de requête fournis, soit par un <code>find()</code> avec la clé primaire (<code>{id}</code> dans notre cas), soit par un <code>findBy()</code> si c’est une propriété de l’objet qui est fournie (ex : le nom ou toute autre clé unique).</li>
<li>Si aucun objet n’est trouvé, le convertisseur retourne une 404.</li>
<li>Si un objet est trouvé, il est ajouté aux attributs de la requête et automatiquement injecté dans le paramètre de l’action.</li>
</ul>
<p>Pour plus d'information : <a href="https://symfony.com/doc/current/bundles/SensioFrameworkExtraBundle/annotations/converters.html">@ParamConverter</a></p>
<h4><a class="anchor" aria-hidden="true" id="comment-réaliser-la-correspondance-id_cinema-cinemaid-et-id_film-filmid"></a><a href="#comment-réaliser-la-correspondance-id_cinema-cinemaid-et-id_film-filmid" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Comment réaliser la correspondance <code>id_cinema-&gt;Cinema.id</code> et <code>id_film-&gt;Film.id</code></h4>
<p>Par défaut, Symfony propose deux convertisseurs :  Doctrine converter et DateTime converter.</p>
<p>Le convertisseur <code>DoctrineParamConverter</code> du framework Symfony définit l'annotation <code>@ParamConverter</code>. Parmis, les différentes options de cette annotation, nous allons utiliser le mapping qui définit la correspondance entre des parties de la route et les infos des entités pour réaliser l'injection automatique.</p>
<h4><a class="anchor" aria-hidden="true" id="implémentation-1"></a><a href="#implémentation-1" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Implémentation</h4>
<pre><code class="hljs css language-php"><span class="hljs-comment">// ApiFilmAAficheController</span>

<span class="hljs-keyword">use</span> <span class="hljs-title">Sensio</span>\<span class="hljs-title">Bundle</span>\<span class="hljs-title">FrameworkExtraBundle</span>\<span class="hljs-title">Configuration</span>\<span class="hljs-title">ParamConverter</span>;

<span class="hljs-comment">/**
* <span class="hljs-doctag">@Rest</span>\View()
* <span class="hljs-doctag">@Rest</span>\Post("/api/filmsAAFiche/{id_cinema}/{id_film}")
* <span class="hljs-doctag">@ParamConverter</span>("cinema", class="App\Entity\Cinema", options={"mapping": {"id_cinema": "id"}})
* <span class="hljs-doctag">@ParamConverter</span>("film", class="App\Entity\Film", options={"mapping": {"id_film": "id"}})
*/</span>
<span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">postFilmAAfiche</span><span class="hljs-params">(
            Cinema $cinema,
            Film $film,
            ProgrammationCinemaHandler $handler)</span></span>{
$query = <span class="hljs-keyword">new</span> ProgrammationCinemaQuery($cinema);
$handler-&gt;addFilmProgrammationCinema($query, $film);
}
</code></pre>
<pre><code class="hljs css language-php"><span class="hljs-comment">// ProgrammationCinemaHandler</span>

<span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">addFilmProgrammationCinema</span><span class="hljs-params">(
                ProgrammationCinemaQuery $query,
                Film $film)</span> </span>{
    <span class="hljs-keyword">$this</span>-&gt;programme-&gt;mettreFilmAAffiche($film, $query-&gt;getCinema());
}
</code></pre>
<pre><code class="hljs css language-php"><span class="hljs-comment">// DoctrineProgrammeDeCinema</span>

<span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">mettreFilmAAffiche</span><span class="hljs-params">(Film $film,Cinema $cinema)</span>
</span>{
    $filmAAffiche = <span class="hljs-keyword">new</span> FilmAAffiche($film,$cinema);
    <span class="hljs-keyword">$this</span>-&gt;save($filmAAffiche);
}
</code></pre>
<pre><code class="hljs css language-php"><span class="hljs-comment">/**
 * <span class="hljs-doctag">@ORM</span>\Entity(repositoryClass="DoctrineProgrammeDeCinema")
 */</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">FilmAAffiche</span> </span>{
    ... 

    <span class="hljs-comment">/**
     * <span class="hljs-doctag">@ORM</span>\ManyToOne(targetEntity="App\Entity\Cinema")
     * <span class="hljs-doctag">@ORM</span>\JoinColumn(nullable=false)
     */</span>
    <span class="hljs-keyword">private</span> $cinema;

    <span class="hljs-comment">/**
     * <span class="hljs-doctag">@ORM</span>\ManyToOne(targetEntity="App\Entity\Film")
     * <span class="hljs-doctag">@ORM</span>\JoinColumn(nullable=false)
     * <span class="hljs-doctag">@Groups</span>("filmsAAFiche")
     */</span>
    <span class="hljs-keyword">private</span> $film;

    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span><span class="hljs-params">(Film $film,Cinema $cinema)</span> </span>{
        <span class="hljs-keyword">$this</span>-&gt;film=$film;
        <span class="hljs-keyword">$this</span>-&gt;cinema=$cinema;
    }
    ... 
}

</code></pre>
<h4><a class="anchor" aria-hidden="true" id="test-1"></a><a href="#test-1" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Test</h4>
<ul>
<li>liste des films à l'affiche du cinéma id=1</li>
</ul>
<div align="center" ><img alt="" src="/img/api4/capture01.png" width="400" height="200" /></div>
<ul>
<li>ajouter le film id=2 à l'affiche du cinéma id=1</li>
</ul>
<div align="center" ><img alt="" src="/img/api4/capture02.png" width="400" height="200" /></div>
<ul>
<li>liste des films à l'affiche du cinéma id=1</li>
</ul>
<div align="center" ><img alt="" src="/img/api4/capture03.png" width="400" height="200" /></div>
<h3><a class="anchor" aria-hidden="true" id="us6--ajouter-un-film-à-laffiche-dun-cinéma-avec-vérification"></a><a href="#us6--ajouter-un-film-à-laffiche-dun-cinéma-avec-vérification" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>US6 : ajouter un film à l’affiche d’un cinéma avec vérification</h3>
<h4><a class="anchor" aria-hidden="true" id="problème"></a><a href="#problème" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Problème</h4>
<div align="center" ><img alt="" src="/img/api4/capture04.png" width="400" height="200" /></div>
<h4><a class="anchor" aria-hidden="true" id="conditions-particulière-à-appliquer-à-lus6"></a><a href="#conditions-particulière-à-appliquer-à-lus6" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Conditions particulière à appliquer à l'US6</h4>
<p>Je ne peux pas mettre deux fois un même film à l’affiche d’un cinéma donné.</p>
<h4><a class="anchor" aria-hidden="true" id="implémentation--solution-1"></a><a href="#implémentation--solution-1" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Implémentation : solution 1</h4>
<p>La route <code>postFilmAAfiche</code> vérifie si le film est présent dans la liste des films à l'affiche du cinéma. Si oui, la route retourne un message d'erreur de type <code>HTTP_FOUND</code>, sino, la route authorise l'ajout du film dans la liste des films à l'affiche du cinéma.</p>
<pre><code class="hljs css language-php"><span class="hljs-comment">/**
* <span class="hljs-doctag">@Rest</span>\View()
* <span class="hljs-doctag">@Rest</span>\Post("/api/filmsAAFiche/{id_cinema}/{id_film}")
* <span class="hljs-doctag">@ParamConverter</span>("cinema", class="App\Entity\Cinema", options={"mapping": {"id_cinema": "id"}})
* <span class="hljs-doctag">@ParamConverter</span>("film", class="App\Entity\Film", options={"mapping": {"id_film": "id"}})
*/</span>
<span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">postFilmAAfiche</span><span class="hljs-params">(
            Cinema $cinema,
            Film $film,
            ProgrammationCinemaHandler $handler)</span></span>{
$listeFilmsAAFiche = <span class="hljs-keyword">$this</span>-&gt;listeFilmsAAFiche($cinema, $handler);
<span class="hljs-keyword">foreach</span> ($listeFilmsAAFiche <span class="hljs-keyword">as</span> $filmAAfiche) {
    <span class="hljs-keyword">if</span> ($film-&gt;getId() == $filmAAfiche-&gt;getId())
        <span class="hljs-keyword">return</span> View::create([<span class="hljs-string">'message'</span> =&gt; <span class="hljs-string">'FilmAAFiche already exists'</span>], Response::HTTP_FOUND);
}
$query = <span class="hljs-keyword">new</span> ProgrammationCinemaQuery($cinema);
$handler-&gt;addFilmProgrammationCinema($query, $film);
<span class="hljs-keyword">return</span> View::create([<span class="hljs-string">'message'</span> =&gt; <span class="hljs-string">'FilmAAFiche added'</span>], Response::HTTP_OK);
}
</code></pre>
<h4><a class="anchor" aria-hidden="true" id="implémentation--solution-2---validator"></a><a href="#implémentation--solution-2---validator" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Implémentation : solution 2 - Validator</h4>
<p>On exploite la validation des données avant mises à jour.<br>
Dans notre cas, on doit interdire l'ajout plus d'une fois d'un film dans la liste des films à l'affiche d'un cinéma. Autrement dit, le couple <code>(cinema, film)</code> dans l'entité <code>filmAAFiche</code> est une clé unique.</p>
<h5><a class="anchor" aria-hidden="true" id="installer-le-nécessaire"></a><a href="#installer-le-nécessaire" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Installer le nécessaire</h5>
<p>Dans le conteneur <code>api</code> :</p>
<pre><code class="hljs"><span class="hljs-attr">composer</span> <span class="hljs-string">update</span>
<span class="hljs-attr">composer</span> <span class="hljs-string">require symfony/orm-pack \
         symfony/form \
         symfony/security-bundle \
         symfony/validator</span>
</code></pre>
<h5><a class="anchor" aria-hidden="true" id="configuration"></a><a href="#configuration" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Configuration</h5>
<div align="center" ><img alt="" src="/img/api4/capture08.png" width="400" height="200" /></div>
<h5><a class="anchor" aria-hidden="true" id="implémentation-2"></a><a href="#implémentation-2" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Implémentation</h5>
<pre><code class="hljs css language-php"><span class="hljs-comment">// App/Entity/FilmAAffiche</span>

<span class="hljs-keyword">use</span> <span class="hljs-title">Symfony</span>\<span class="hljs-title">Bridge</span>\<span class="hljs-title">Doctrine</span>\<span class="hljs-title">Validator</span>\<span class="hljs-title">Constraints</span>\<span class="hljs-title">UniqueEntity</span>;

<span class="hljs-comment">/**
 * <span class="hljs-doctag">@ORM</span>\Entity(repositoryClass="App\Repository\DoctrineProgrammeDeCinema")
 * <span class="hljs-doctag">@UniqueEntity</span>(
 *  fields={"cinema","film"},
 *  errorPath="film",
 *  message="Film already presents in listFilmsAAFiche for this cinema."
 * )
 */</span>

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">FilmAAffiche</span> </span>{
    ...
}
</code></pre>
<pre><code class="hljs css language-php"><span class="hljs-comment">// App/Controller/ApiFilmAAficheController</span>
<span class="hljs-keyword">use</span> <span class="hljs-title">Symfony</span>\<span class="hljs-title">Component</span>\<span class="hljs-title">Validator</span>\<span class="hljs-title">Validator</span>\<span class="hljs-title">ValidatorInterface</span>;

<span class="hljs-comment">/**
* <span class="hljs-doctag">@Rest</span>\View()
* <span class="hljs-doctag">@Rest</span>\Post("/api/filmsAAFiche/{id_cinema}/{id_film}")
* <span class="hljs-doctag">@ParamConverter</span>("cinema", class="App\Entity\Cinema", options={"mapping": {"id_cinema": "id"}})
* <span class="hljs-doctag">@ParamConverter</span>("film", class="App\Entity\Film", options={"mapping": {"id_film": "id"}})
*/</span>
<span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">postFilmAAfiche</span><span class="hljs-params">(
    Cinema $cinema,
    Film $film,
    ProgrammationCinemaHandler $handler,
    ValidatorInterface $validator)</span></span>{

    $filmAAffiche = <span class="hljs-keyword">new</span> FilmAAffiche($film,$cinema);

    $errors = $validator-&gt;validate($filmAAffiche);
    <span class="hljs-keyword">if</span> (count($errors))
        <span class="hljs-keyword">return</span> View::create($errors, Response::HTTP_FOUND);

    $query = <span class="hljs-keyword">new</span> ProgrammationCinemaQuery($cinema);
    $handler-&gt;addFilmProgrammationCinema($query, $film);
}
</code></pre>
<h5><a class="anchor" aria-hidden="true" id="test-2"></a><a href="#test-2" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Test</h5>
<p>Ajout de 2 fois le film <code>id=1</code> au cinema <code>id=1</code></p>
<div align="center" ><img alt="" src="/img/api4/capture05.png" width="400" height="200" /></div>
</span></div></article></div><div class="docs-prevnext"><a class="docs-prev button" href="/docs/api03.html"><span class="arrow-prev">← </span><span>Étape 3</span></a><a class="docs-next button" href="/docs/vueAvion.html"><span>Vue d&#x27;avion</span><span class="arrow-next"> →</span></a></div></div></div><nav class="onPageNav"><ul class="toc-headings"><li><a href="#objectifs">Objectifs</a></li><li><a href="#développement">Développement</a></li><li><a href="#branches-dans-la-répo-git">Branches dans la répo GIT</a></li><li><a href="#spécification-de-lapi-par-us">Spécification de l'API par US</a></li><li><a href="#conditions-particulière-à-appliquer-à-lapi">Conditions particulière à appliquer à l'API</a></li><li><a href="#implémentation">Implémentation</a><ul class="toc-headings"><li><a href="#us3--liste-des-films-à-laffiche-dun-cinéma">US3 : liste des films à l'affiche d'un cinéma</a></li><li><a href="#création-du-contrôleur-apifilmaafichecontrollerphp">Création du contrôleur <code>ApiFilmAAficheController.php</code></a></li><li><a href="#route--get-apifilmsaaficheid">Route : <code>Get /api/filmsAAFiche/{id}</code></a></li><li><a href="#test-">Test :</a></li><li><a href="#sérialisation-des-entités-avec-des-relations">Sérialisation des entités avec des relations</a></li><li><a href="#sérialisation-des-films-à-laffiche-dun-cinéma">Sérialisation des films à l'affiche d'un cinéma</a></li><li><a href="#us6--ajouter-un-film-à-laffiche-dun-cinéma">US6 : ajouter un film à l’affiche d’un cinéma</a></li><li><a href="#route--post-apifilmsaaficheid_cinemaid_film">Route : <code>Post /api/filmsAAFiche/{id_cinema}/{id_film}</code></a></li><li><a href="#us6--ajouter-un-film-à-laffiche-dun-cinéma-avec-vérification">US6 : ajouter un film à l’affiche d’un cinéma avec vérification</a></li></ul></li></ul></nav></div><footer class="nav-footer" id="footer"><section class="sitemap"><a href="/" class="nav-home"></a><div><a href="https://lpdevmob2019.slack.com/messages/CPC8JBLGK">Slack</a></div></section><section class="copyright">Copyright © 2021 Sylvain Ferlac</section></footer></div></body></html>